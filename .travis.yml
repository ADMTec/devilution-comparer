dist: trusty
language: rust
addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - g++-7
env:
  global:
    - LIBCLANG_PATH=/usr/local/clang-5.0.0/lib
    - CRATE_NAME=devilution-comparer

matrix:
  include:
    - env: TARGET=x86_64-unknown-linux-gnu
      rust: nightly

before_install:
  - set -e
  - export CC=gcc-7
  - export CXX=g++-7
  - rustup self update

install:
  - source ~/.cargo/env || true

script:
  - bash ci/script.sh

after_script: set +e

before_deploy:
  - sh ci/before_deploy.sh

deploy:
  api_key:
    secure: "j3ZqU6zy0RHgZ7E9zzXi5jUpuZGTtEk841wyapCPl7F5xKYLIJkWxvLRUBiq0/EOgfQ7CaiZOBnaCtjrajr46mYxOevkwAoAmRoyVjF+ptEFG9KfZZ1ibjgqQNPtUPr8UQxsx6By0zq78ZXT2qQdcc8DySzpy6LJd9EfSoTHAy8JKA9xWBUDVdQeQX1NwZ/5w0y4lL4efdZDkZp8BesFx9ElYSSzyoMKNY1G2sWhHGSvA0sJdsY8ZudG70haDfJVsIEVdMrvA+mhUbmTvurb7GB/79+OgATw/EB8KGWFq1KKd9vAF3Pbe2++UP7aptuZktSeJV405x379mBHj50K29Utsd1eb/5n1PtFSse1KHLYcm7r2VDcljC3HOCOxKVvqCpcDJrjAztgXppaqBskwGlLFxOt9sy5flVEIhoYrT5SZGxXU82LJG+rbd97JUseMNxgzxtnjPWCcvdaPzeuIu2Efw8+7n7rxCFIAdva1r+9GqovL9K67vW4CsAT+T8jfgME9i6NYqco9mTohug+95Nq2K1v8mjT4akYTj9CSqDBz4qYZx8F1p7H0e7ZvPrixzYzIVLjl9CLTEHvO+CWHLED86H08BCcuj4ye6SHAbDEY/4Tr4B3ri6aW2cb7xhBdx0v4gxdUZsp/75XnFXd3GNndF2KIG0WqauPhIZu6OU="
  #file_glob: true
  file: $CRATE_NAME-$TRAVIS_TAG-$TARGET.tar.xz
  on:
    #condition: $TRAVIS_RUST_VERSION = stable
    tags: true
  provider: releases
  skip_cleanup: true

cache: cargo
before_cache:
  # Travis can't cache files that are not readable by "others"
  - chmod -R a+r $HOME/.cargo

branches:
  only:
    # release tags
    - /^v\d+\.\d+\.\d+.*$/
    - master

notifications:
  email:
    on_success: never
